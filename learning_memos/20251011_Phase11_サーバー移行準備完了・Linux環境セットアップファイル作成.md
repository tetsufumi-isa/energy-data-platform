# Phase 11 進捗報告: サーバー移行準備完了・Linux環境セットアップファイル作成

**日時**: 2025年10月11日
**Phase**: 11（基盤整備→日次運用→予測精度分析）
**セッション内容**: Linux環境へのサーバー移行準備、自動セットアップファイル作成完了

---

## 📊 セッション概要

前回セッションでの7月～10月データ投入完了に続き、Windows開発環境からLinux本番環境への移行準備を実施。git cloneしたらすぐに使える環境を構築するためのファイル群を作成。

### 実施内容
- 現在のWindows環境の設定調査（環境変数、GCP認証、パッケージ依存関係）
- Linux用セットアップスクリプト作成（setup.sh）
- 環境変数テンプレート作成（.env.template）
- Pythonパッケージリスト作成（requirements.txt）
- サーバー移行手順書作成（SETUP.md）
- GCP認証キー管理方法の明確化

---

## ✅ 主要成果

### 1. requirements.txt 作成

**内容:**
```txt
# Google Cloud Platform
google-cloud-bigquery>=3.10.0
google-cloud-storage>=2.10.0

# Data processing
pandas>=2.0.0
numpy>=1.24.0

# Machine learning
xgboost>=2.0.0
scikit-learn>=1.3.0

# Visualization
matplotlib>=3.7.0
seaborn>=0.12.0

# HTTP requests
requests>=2.31.0

# Environment variables
python-dotenv>=1.0.0
```

**ポイント:**
- プロジェクトで使用する全パッケージをバージョン指定付きで記載
- Linux環境で `pip install -r requirements.txt` するだけで依存関係解決

### 2. .env.template 作成

**内容:**
```bash
# プロジェクトルートパス
ENERGY_ENV_PATH=/path/to/energy-env

# GCP認証キーファイルのパス
GOOGLE_APPLICATION_CREDENTIALS=/path/to/energy-env/keys/energy-data-processor-key.json

# GCPプロジェクトID（オプション）
# GCP_PROJECT_ID=your-project-id
```

**ポイント:**
- 環境変数のテンプレート
- Gitリポジトリに含める（機密情報なし）
- Linux側で `.env` にコピーして編集

### 3. setup.sh 作成（Linux用自動セットアップ）

**主な機能:**
1. Pythonバージョン確認
2. 仮想環境作成
3. pipアップグレード
4. requirements.txtからパッケージインストール
5. .envファイル自動生成
6. 必要なディレクトリ構造作成
7. ENERGY_ENV_PATHの自動設定

**実行方法:**
```bash
chmod +x setup.sh
bash setup.sh
```

### 4. SETUP.md 作成（サーバー移行手順書）

**記載内容:**
- 前提条件（Python, Git, GCP要件）
- セットアップ手順（git clone → setup.sh実行 → GCP認証キー配置）
- GCP接続テスト手順
- cron設定例（日次処理自動実行）
- トラブルシューティング
- セキュリティ注意事項
- セットアップチェックリスト

### 5. GCP認証キー管理方法の明確化

**調査結果:**
- **現在のWindows環境**: `C:\Users\tetsu\dev\energy-env\keys\energy-data-processor-key.json` を使用
- **環境変数**: `GOOGLE_APPLICATION_CREDENTIALS` で指定
- **サービスアカウント**: `energy-data-processor@energy-env.iam.gserviceaccount.com`

**Linux側での対応:**
- JSONキーファイルは `.gitignore` で除外（機密情報）
- **手動でWindows → Linuxに転送**が必要
- scpコマンドまたはGUIツール（WinSCP等）で転送
- パーミッション設定: `chmod 600 keys/energy-data-processor-key.json`

---

## 🎯 技術的理解の向上

### 1. 環境変数とGCP認証の仕組み

**認証の流れ:**
1. 環境変数 `GOOGLE_APPLICATION_CREDENTIALS` でJSONキーのパスを指定
2. PythonのGCPライブラリ（bigquery, storage）が自動的にこのキーを読み込む
3. サービスアカウントの秘密鍵を使ってGCPにアクセス

**重要なポイント:**
- JSONキーファイルには秘密鍵（private_key）が含まれる
- Gitにコミットすると全世界に公開されるリスク
- `.gitignore` で除外し、手動転送が必須

### 2. 開発環境と本番環境の分離

**開発環境（Windows）:**
- 手動でのデータ確認
- コード修正・テスト
- Gitでバージョン管理

**本番環境（Linux）:**
- 自動化された日次処理
- cronによるスケジュール実行
- ログ監視・エラー通知

### 3. 冪等性を保つセットアップ

**setup.shの設計:**
- 既存の仮想環境がある場合は再作成確認
- .envファイルが既にある場合は上書きしない
- ディレクトリが存在する場合はエラーにならない（mkdir -p）
- 複数回実行しても安全

---

## 📁 作成ファイル一覧

### 新規作成
- `requirements.txt` - Pythonパッケージリスト
- `.env.template` - 環境変数テンプレート
- `setup.sh` - Linux用自動セットアップスクリプト
- `SETUP.md` - サーバー移行手順書
- `learning_memos/20251011_Phase11_サーバー移行準備完了・Linux環境セットアップファイル作成.md` - このファイル

### 確認済み（修正なし）
- `.gitignore` - 機密情報除外設定（keys/, .env, venv/ など）

---

## 🔄 次回セッション予定

### 次のタスク: Linux側でのセットアップ実施

**サーバー側での実装作業:**
1. Linuxサーバーへのアクセス確認
2. git clone実行
3. GCP認証キーファイル転送
4. setup.sh実行
5. 環境変数設定（.env編集）
6. GCP接続テスト
7. データダウンロードテスト

**その後:**
- cron設定（日次処理の自動実行）
- ログ監視ダッシュボードの確認
- エラー通知の仕組み構築

---

## 📝 TODOリスト全体

### ✅ 完了済み（今回）
1. ~~既存の環境変数・設定ファイルを確認~~ ✓
2. ~~requirements.txt作成（Pythonパッケージリスト）~~ ✓
3. ~~.env.templateファイル作成（環境変数テンプレート）~~ ✓
4. ~~setup.shスクリプト作成（Linux用セットアップ自動化）~~ ✓
5. ~~SETUP.md作成（サーバー移行手順書）~~ ✓
6. ~~.gitignore確認・更新（機密情報除外確認）~~ ✓

### 📋 未完了タスク

#### 優先度高（次回実施）
7. **Linux側でのセットアップ実施** [次回、サーバー側]
   - git clone
   - GCP認証キー転送
   - setup.sh実行
   - 環境変数設定
   - 接続テスト

8. **日次処理実装（電気・天気の自動実行）** [サーバー側]
   - cron設定
   - ログ監視

#### 機能実装
9. 異常検知システム実装
10. 過去5回分の予測実行（例：10/4、10/3、10/2、10/1、9/30）
11. 予測精度検証モジュール実装（1日目～16日目の精度を5回分平均で算出）

#### データ基盤
12. BQ修正・作成（精度検証結果反映）
13. 日次実行セット（予測+精度検証の自動運用開始）

#### 可視化
14. Looker Studio予測結果表示ダッシュボード作成
15. Looker Studio監視ページ作成（プロセス実行ログ・エラー監視）

#### GCSアップロード機能（後回し可）
16. gcs_uploaderをdata_type対応にリファクタリング（power/weather/prediction）
17. power_bigquery_loaderからgcs_uploader呼び出し実装
18. weather_bigquery_loaderからgcs_uploader呼び出し実装
19. prediction系モジュールからgcs_uploader呼び出し実装

#### 自動化（最終段階）
20. Airflow環境構築・DAG実装（Cloud Composer使用）

---

## 💡 学んだこと

### セキュリティベストプラクティス
- **機密情報はGitに含めない**: 秘密鍵、パスワード、APIキーなど
- **.gitignoreで除外**: keys/, credentials/, .env
- **テンプレートファイルのみバージョン管理**: .env.template
- **手動転送が必須**: 機密情報はscp等で個別に転送

### 再現可能な環境構築
- **requirements.txt**: パッケージ依存関係の明示化
- **setup.sh**: 環境構築の自動化
- **ドキュメント化**: SETUP.mdで手順を明確化
- **冪等性**: 何度実行しても安全なスクリプト設計

### 開発ワークフロー
1. ローカル（Windows）で開発・テスト
2. Gitにコミット（コード + 設定ファイル）
3. Linuxサーバーでgit clone
4. セットアップスクリプト実行
5. 機密情報を手動配置
6. 本番運用開始

---

**次回**: Linuxサーバー側でのセットアップ実施・日次処理稼働開始
