# Phase 11 データソーステーブルリファクタリング・日付マッピング方式実装

## セッション概要
**日付**: 2025年9月30日
**作業内容**: 予測データソース追跡・本番環境テーブル設計・date_lag_mapping方式実装
**成果**: 効率的なlag特徴量取得アーキテクチャ設計完了・本番環境初期テーブル構築完了

## 今回の主要成果

### 1. 予測データソース完全追跡
- **prediction_iterative_with_export.py解析**: 使用CSVと依存関係を完全解明
- **ml_features.csv**: 予測に使用する12特徴量データ（date, hour, actual_power, 気象, カレンダー, lag特徴量）
- **BQテーブル構造解明**: dev環境のテーブル依存関係を完全把握
  ```
  energy_data_hourly (実績電力) + weather_data (気象) + calendar_data (カレンダー)
    → power_weather_integrated (ビュー)
    → business_days_lag + all_days_lag (lag特徴量計算)
    → ml_features (統合テーブル)
  ```

### 2. 日付マッピングテーブル方式の考案
- **課題**: 従来方式ではlag特徴量計算に複雑なウィンドウ関数（60JOIN相当）
- **解決策**: 日付マッピングテーブル方式
  - `date_lag_mapping`: 各日付に対して「N日前の日付」「N営業日前の日付」を事前計算
  - lag特徴量取得は単純なJOINで実現（3JOIN）
  - 2023-2027年分を一度作成すれば更新不要

### 3. 本番環境テーブル設計完了
- **データセット**: `energy-env.prod_energy_data`
- **ロケーション**: `us-central1`
- **パーティショニング戦略**: 全データテーブルにdate列でパーティション設定 + 3年保持
  - `energy_data_hourly`: 電力実績データ
  - `weather_data`: 気象データ
  - `calendar_data`: カレンダーデータ（2027年まで）
  - `date_lag_mapping`: 日付マッピング（2027年まで）
  - `ml_features`: 統合特徴量テーブル

### 4. 本番環境初期構築完了
- ✅ `calendar_data`: dev環境からコピー完了
- ✅ `date_lag_mapping`: 2023-2027年分作成完了
- ✅ `energy_data_hourly`: パーティション設定でコピー完了
- ✅ `weather_data`: パーティション設定でコピー完了
- 🔄 `ml_features`: テーブル作成SQL準備完了（実行待ち）

## 技術的理解の向上

### date_lag_mapping方式の設計

#### テーブル構造
```sql
date_lag_mapping (
  base_date DATE,                    -- 基準日
  lag_1_day_date DATE,               -- 1日前の日付
  lag_7_day_date DATE,               -- 7日前の日付
  ...
  lag_30_day_date DATE,              -- 30日前の日付
  lag_1_business_date DATE,          -- 1営業日前の日付
  ...
  lag_30_business_date DATE          -- 30営業日前の日付
)
```

#### 営業日lag計算ロジック
```sql
-- 営業日に連番を付与
business_days AS (
  SELECT date, ROW_NUMBER() OVER (ORDER BY date) as biz_row_num
  FROM calendar_data
  WHERE NOT is_holiday AND NOT is_weekend
)
-- N営業日前 = 自分のbiz_row_num - N の日付
```

#### ml_features作成（シンプルなJOIN）
```sql
SELECT
  base.*,
  lag1.actual_power as lag_1_day,
  lag7.actual_power as lag_7_day,
  blag1.actual_power as lag_1_business_day
FROM base_data base
LEFT JOIN date_lag_mapping dlm ON base.date = dlm.base_date
LEFT JOIN base_data lag1 ON lag1.date = dlm.lag_1_day_date AND lag1.hour = base.hour
LEFT JOIN base_data lag7 ON lag7.date = dlm.lag_7_day_date AND lag7.hour = base.hour
LEFT JOIN base_data blag1 ON blag1.date = dlm.lag_1_business_date AND blag1.hour = base.hour
```

### パーティショニング戦略の理解

#### 設計方針
```sql
CREATE TABLE table_name
PARTITION BY date
OPTIONS(partition_expiration_days=1095)  -- 3年保持
```

#### メリット
- クエリパフォーマンス向上（必要なパーティションのみスキャン）
- 自動的に古いデータ削除（手動メンテナンス不要）
- コスト削減（スキャン量削減）

### 日次運用での更新範囲の整理

#### 東電APIの制約
- **月単位でしか取得できない**
- 当日実績のみ取得は不可能

#### 更新戦略
- **energy_data_hourly, weather_data**: 当月全置換
- **ml_features**: 当月全置換（lag特徴量は過去データ参照）
- **prediction_results**: 当月全置換

#### 予測期間の月跨ぎ対応
- 例: 9/25実行 → 9/26～10/11予測（16日間）
- 解決策: 予測実行時は未来データを動的生成
  - `ml_features`: 当月まで（実績ベース）
  - 予測用の10月データ: `calendar_data` + `weather_data`（予測）から動的生成
  - lag特徴量: Python内のpredictions辞書から参照

## 作成したSQLファイル

### 1. `sql/create_date_lag_mapping.sql`
- date_lag_mappingテーブル作成（2023-2027）
- 営業日lag計算ロジック実装

### 2. `sql/copy_data_to_prod.sql`
- energy_data_hourly、weather_dataをdev→prod環境へコピー
- パーティション設定付き

### 3. `sql/create_ml_features_table.sql`
- ml_featuresテーブル作成（パーティション + 3年保持）
- date_lag_mapping方式でlag特徴量JOIN
- 実行待ち（明日確認予定）

## 実装Todo（優先順）

1. ✅ **段階的予測の連鎖ロジック解明** - 完了
2. ✅ **prediction_iterative_with_export.pyのデータソース追跡** - 完了
3. ✅ **データソーステーブルの本番環境適切化設計** - 完了
4. ✅ **date_lag_mappingテーブル作成（2023-2027）** - 完了
5. 🔄 **ml_featuresテーブル作成（lag特徴量3つJOIN版）** - SQL準備完了・実行待ち
6. ⏳ **予測コードBQ対応：予測データは電力は予測値・気象とカレンダーはml_features以外から別途取得**
7. ⏳ **日次実行ロジック実装（当月全置換方式）**
8. ⏳ **ML_PREDICTIONステータスログ保存システム実装**
9. ⏳ **BQ_PROCESSINGステータスログ保存システム実装**
10. ⏳ **weather_downloader.pyにWEATHER_APIステータス実装**
11. ⏳ **データ異常検知システム設計・実装（BQクエリ+Python判定）**

## 次回セッション予定

### 優先実装項目
1. **ml_features作成SQLの実行・検証**
   - テーブル作成実行
   - lag特徴量の正確性確認
   - データ件数・期間の確認

2. **予測コードのBQ対応実装**
   - CSV読み込み → BQクエリに変更
   - calendar_data, weather_data（予測）の取得ロジック実装
   - 予測期間の未来データ生成ロジック実装

3. **日次実行ロジック設計**
   - データ取得（当月全体）
   - BQ投入（当月全置換）
   - 予測実行
   - 結果保存

## プロジェクト全体への影響

### アーキテクチャの改善
- **保守性向上**: lag特徴量計算ロジックがシンプル化（date_lag_mapping参照のみ）
- **拡張性向上**: 新しいlag特徴量追加が容易（date_lag_mappingにカラム追加 + JOIN追加）
- **パフォーマンス向上**: 複雑なウィンドウ関数不要、事前計算済みテーブル参照

### 本番環境の基盤確立
- **prod_energy_data**: 本番データセット作成完了
- **パーティショニング**: 自動データ管理の仕組み確立
- **3年保持ポリシー**: 学習データ確保 + 自動削除

### 日次運用への道筋
- **更新対象明確化**: energy_data_hourly, weather_data, ml_features
- **月単位全置換**: 東電API制約に適合した設計
- **予測期間月跨ぎ対応**: 動的データ生成で解決

---

**次回**: ml_features作成SQL実行・予測コードBQ対応開始
**目標**: Phase 11基盤修正フェーズ完了・日次実行ロジック実装開始